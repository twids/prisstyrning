var De=Object.defineProperty;var Ae=(r,t,s)=>t in r?De(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var J=(r,t,s)=>Ae(r,typeof t!="symbol"?t+"":t,s);import{u as T,j as e,a as W,b as E,Q as ke,c as Fe}from"./query-3C2qzm7n.js";import{c as Ie,L as X,r as A,B as Ee,d as Pe,e as V,a as He}from"./react-vendor-B40RXkHJ.js";import{t as Te,v as x,A as Le,w as ze,T as a,B as w,D as Re,S as $e,x as qe,C as z,y as P,z as Q,E as We,F as L,G as ge,H as N,J as K,K as k,s as Z,L as S,M as C,O as Y,Q as Be,R as Me,U as Ue,V as Oe,W as ye,X as pe,Y as fe,Z as je,$ as ve,a0 as re,a1 as G,a2 as ae,a3 as q,a4 as R,a5 as le,a6 as ce,a7 as de,a8 as ee,a9 as Ne,aa as se,ab as Ke,ac as Qe,ad as Ge,ae as te,af as v,ag as Ze,ah as _e,I as Je,ai as ue,aj as Xe,ak as Ve,al as Ye}from"./mui-core-B18h7gGm.js";import{f as be}from"./date-utils-CBpsKyOP.js";import{L as et}from"./mui-charts-CNiBRNS8.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const u of d.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&l(u)}).observe(document,{childList:!0,subtree:!0});function s(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function l(o){if(o.ep)return;o.ep=!0;const d=s(o);fetch(o.href,d)}})();var ne={},he=Ie;ne.createRoot=he.createRoot,ne.hydrateRoot=he.hydrateRoot;const tt=Te({palette:{mode:"dark",primary:{main:"#4FC3F7"},secondary:{main:"#FFB74D"},background:{default:"#121212",paper:"#1e1e1e"},success:{main:"#8BC34A"},warning:{main:"#FFB74D"},error:{main:"#EF5350"}},typography:{fontFamily:'"Roboto", "Helvetica", "Arial", sans-serif'},components:{MuiButton:{styleOverrides:{root:{textTransform:"none"}}}}});class rt{constructor(){J(this,"baseUrl","")}async getAuthStatus(){return this.get("/auth/daikin/status")}async startAuth(){return this.get("/auth/daikin/start")}async refreshAuth(){return this.post("/auth/daikin/refresh")}async revokeAuth(){return this.post("/auth/daikin/revoke")}async getPriceTimeseries(t){const s=t?`?source=${t}`:"";return this.get(`/api/prices/timeseries${s}`)}async getZone(){return this.get("/api/prices/zone")}async setZone(t){return this.post("/api/prices/zone",{zone:t})}async getSchedulePreview(){return this.get("/api/schedule/preview")}async getScheduleHistory(){return this.get("/api/user/schedule-history")}async getUserSettings(){return this.get("/api/user/settings")}async saveUserSettings(t){return this.post("/api/user/settings",t)}async getDaikinSites(){return this.get("/api/daikin/sites")}async getGatewayDevices(){return this.get("/api/daikin/gateway?debug=true")}async getCurrentSchedule(t){const s=t?`?embeddedId=${t}`:"";return this.get(`/api/daikin/gateway/schedule${s}`)}async applySchedule(t){return this.post("/api/daikin/gateway/schedule/put",t)}async getFlexibleState(){return this.get("/api/user/flexible-state")}async getStatus(){return this.get("/api/status")}async getAdminStatus(){return this.get("/api/admin/status")}async adminLogin(t){const s=await fetch(this.baseUrl+"/api/admin/login",{method:"POST",headers:{"X-Admin-Password":t},credentials:"same-origin"});if(!s.ok){const l=await s.text();throw new Error(this.extractErrorMessage(l)||`HTTP ${s.status}`)}return s.json()}async getAdminUsers(){return this.get("/api/admin/users")}async grantAdmin(t){return this.post(`/api/admin/users/${encodeURIComponent(t)}/grant`)}async revokeAdmin(t){return this.del(`/api/admin/users/${encodeURIComponent(t)}/grant`)}async grantHangfire(t){return this.post(`/api/admin/users/${encodeURIComponent(t)}/hangfire`)}async revokeHangfire(t){return this.del(`/api/admin/users/${encodeURIComponent(t)}/hangfire`)}async deleteUser(t){return this.del(`/api/admin/users/${encodeURIComponent(t)}`)}async get(t){const s=await fetch(this.baseUrl+t,{credentials:"same-origin"});if(!s.ok){const l=await s.text();throw new Error(this.extractErrorMessage(l)||`HTTP ${s.status}: ${t}`)}return s.json()}async post(t,s){const l=await fetch(this.baseUrl+t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:s?JSON.stringify(s):void 0});if(!l.ok){const o=await l.text();throw new Error(this.extractErrorMessage(o)||`HTTP ${l.status}: ${t}`)}return l.json()}async del(t){const s=await fetch(this.baseUrl+t,{method:"DELETE",credentials:"same-origin"});if(!s.ok){const l=await s.text();throw new Error(this.extractErrorMessage(l)||`HTTP ${s.status}: ${t}`)}return s.json()}extractErrorMessage(t){if(!t)return"";try{const s=JSON.parse(t);if(typeof s.error=="string")return s.error}catch{}return t}}const p=new rt;function st({children:r}){var l;const s=((l=T({queryKey:["admin-status"],queryFn:()=>p.getAdminStatus(),staleTime:3e5}).data)==null?void 0:l.isAdmin)??!1;return e.jsxs(x,{sx:{display:"flex",flexDirection:"column",minHeight:"100vh"},children:[e.jsx(Le,{position:"static",children:e.jsxs(ze,{children:[e.jsx(a,{variant:"h6",component:"div",sx:{flexGrow:1},children:"Prisstyrning"}),e.jsx(w,{color:"inherit",component:X,to:"/",startIcon:e.jsx(Re,{}),children:"Dashboard"}),e.jsx(w,{color:"inherit",component:X,to:"/settings",startIcon:e.jsx($e,{}),children:"Settings"}),s&&e.jsx(w,{color:"inherit",component:X,to:"/admin",startIcon:e.jsx(qe,{}),children:"Admin"})]})}),e.jsx(z,{component:"main",sx:{flex:1,py:4},children:r})]})}function ie(){const r=W(),{data:t,isLoading:s,error:l}=T({queryKey:["auth","status"],queryFn:()=>p.getAuthStatus(),refetchInterval:60*1e3,retry:1}),o=E({mutationFn:()=>p.refreshAuth(),onSuccess:()=>{r.invalidateQueries({queryKey:["auth"]})}}),d=E({mutationFn:()=>p.revokeAuth(),onSuccess:()=>{r.invalidateQueries({queryKey:["auth"]})}}),u=async()=>{const{url:m}=await p.startAuth();window.location.href=m};return{isAuthorized:(t==null?void 0:t.authorized)??!1,expiresAt:(t==null?void 0:t.expiresAtUtc)??null,isLoading:s,error:l,startAuth:u,refresh:o.mutateAsync,revoke:d.mutateAsync,isRefreshing:o.isPending,isRevoking:d.isPending}}function nt(){const{isAuthorized:r,expiresAt:t,isLoading:s}=ie();if(s)return e.jsx(P,{size:24});if(!r)return e.jsx(Q,{icon:e.jsx(We,{}),label:"Not Authorized",color:"error",size:"small"});const l=t?new Date(t):null,o=l?`Expires: ${be(l,"PPpp")}`:"Authorized";return e.jsx(L,{title:o,children:e.jsx(Q,{icon:e.jsx(ge,{}),label:"Authorized",color:"success",size:"small"})})}function at(r="latest"){return T({queryKey:["prices","timeseries",r],queryFn:()=>p.getPriceTimeseries(r),refetchInterval:5*60*1e3,staleTime:5*60*1e3})}function it(){const{data:r,isLoading:t,error:s}=at();if(t)return e.jsx(N,{children:e.jsx(K,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(P,{})})});if(s)return e.jsx(N,{children:e.jsx(K,{children:e.jsxs(k,{severity:"error",children:["Failed to load price data: ",s.message]})})});if(!r||r.items.length===0)return e.jsx(N,{children:e.jsx(K,{children:e.jsx(k,{severity:"info",children:"No price data available"})})});const l=[...r.items].sort((m,j)=>new Date(m.start).getTime()-new Date(j.start).getTime()),o=l.map(m=>new Date(m.start).getTime()),d=l.map(m=>m.day==="today"?m.value:null),u=l.map(m=>m.day==="tomorrow"?m.value:null);return e.jsx(N,{children:e.jsxs(K,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Electricity Prices (öre/kWh)"}),e.jsx(et,{xAxis:[{data:o,scaleType:"time",valueFormatter:m=>new Date(m).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}],series:[{label:"Today",data:d,color:"#4FC3F7",showMark:!1,curve:"monotoneX",connectNulls:!1},{label:"Tomorrow",data:u,color:"#FFB74D",showMark:!1,curve:"monotoneX",connectNulls:!1}],height:300,margin:{top:20,right:20,bottom:40,left:60}}),e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{mt:2},children:["Last updated: ",r.updated?new Date(r.updated).toLocaleString("sv-SE"):"N/A"]})]})})}const ot=Z(x)(({theme:r})=>({display:"grid",gridTemplateColumns:"auto repeat(24, 1fr)",gap:r.spacing(.25),alignItems:"center"})),lt=Z(x)(({theme:r})=>({textAlign:"center",fontSize:"0.75rem",color:r.palette.text.secondary,padding:r.spacing(.5)})),xe=Z(x)(({theme:r})=>({fontSize:"0.875rem",fontWeight:500,padding:r.spacing(.5),textAlign:"right",paddingRight:r.spacing(1)})),me=Z(x,{shouldForwardProp:r=>r!=="state"&&r!=="isCurrentHour"})(({theme:r,state:t,isCurrentHour:s})=>({height:32,border:`1px solid ${r.palette.divider}`,borderRadius:r.shape.borderRadius,position:"relative",backgroundColor:t==="comfort"?r.palette.success.main:t==="eco"?r.palette.info.main:t==="turn_off"?r.palette.error.main:r.palette.action.disabledBackground,outline:s?`2px solid ${r.palette.primary.main}`:"none",boxShadow:s?`0 0 6px ${r.palette.primary.main}`:"none",transition:"all 0.2s","&:hover":{transform:"scale(1.05)"}}));function Se({schedulePayload:r}){if(!r)return e.jsx(S,{sx:{p:2},children:e.jsx(a,{color:"text.secondary",children:"No schedule available"})});const t=new Date,s=t.getHours(),l=t.getDay(),o=Object.keys(r)[0],d=r[o],u=(d==null?void 0:d.actions)||{},m=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],j=m[l],f=m[(l+1)%7],F=u[j]||{},I=Array.from({length:24},(b,c)=>{var D;const H=`${c.toString().padStart(2,"0")}:00:00`;return(D=F[H])==null?void 0:D.domesticHotWaterTemperature}),i=u[f]||{},y=Array.from({length:24},(b,c)=>{var D;const H=`${c.toString().padStart(2,"0")}:00:00`;return(D=i[H])==null?void 0:D.domesticHotWaterTemperature});return e.jsx(S,{sx:{p:2},children:e.jsxs(ot,{children:[e.jsx(x,{})," ",Array.from({length:24},(b,c)=>e.jsx(lt,{children:c},c)),e.jsx(xe,{children:"Today"}),I.map((b,c)=>e.jsx(me,{state:b,isCurrentHour:c===s},`today-${c}`)),e.jsx(xe,{children:"Tomorrow"}),y.map((b,c)=>e.jsx(me,{state:b},`tomorrow-${c}`))]})})}function ct(){return e.jsxs(C,{direction:"row",spacing:3,sx:{mt:2},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Y,{sx:{color:"success.main",fontSize:16}}),e.jsx(a,{variant:"body2",children:"Comfort (Heating)"})]}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Y,{sx:{color:"info.main",fontSize:16}}),e.jsx(a,{variant:"body2",children:"Eco (Daily DHW)"})]}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Y,{sx:{color:"error.main",fontSize:16}}),e.jsx(a,{variant:"body2",children:"Turn Off (No Heating)"})]})]})}function dt(){return T({queryKey:["schedule","history"],queryFn:()=>p.getScheduleHistory(),staleTime:60*1e3})}function ut(){const{data:r,isLoading:t,error:s}=dt(),[l,o]=A.useState(!1),d=u=>(m,j)=>{o(j?u:!1)};return t?e.jsx(x,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(P,{})}):s?e.jsxs(k,{severity:"error",children:["Failed to load schedule history: ",s.message]}):!r||r.length===0?e.jsx(k,{severity:"info",children:"No schedule history found. Generate a schedule to see it here."}):e.jsx(x,{children:r.map((u,m)=>{const j=`history-${m}`,f=new Date(u.timestamp);return e.jsxs(Be,{expanded:l===j,onChange:d(j),sx:{mb:1},children:[e.jsx(Me,{expandIcon:e.jsx(Ue,{}),children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:2,width:"100%"},children:[e.jsx(a,{children:be(f,"PPpp")}),e.jsx(Q,{label:u.date,size:"small"})]})}),e.jsx(Oe,{children:e.jsx(Se,{schedulePayload:u.schedule})})]},j)})})}function ht({data:r,title:t}){return e.jsxs(S,{sx:{p:2,bgcolor:"background.default"},children:[t&&e.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:t}),e.jsx(x,{component:"pre",sx:{fontFamily:"monospace",fontSize:"0.875rem",overflow:"auto",maxHeight:400,margin:0},children:JSON.stringify(r,null,2)})]})}function we({open:r,title:t,message:s,confirmText:l="Confirm",cancelText:o="Cancel",onConfirm:d,onCancel:u,isDestructive:m=!1}){return e.jsxs(ye,{open:r,onClose:u,children:[e.jsx(pe,{children:t}),e.jsx(fe,{children:e.jsx(je,{children:s})}),e.jsxs(ve,{children:[e.jsx(w,{onClick:u,children:o}),e.jsx(w,{onClick:d,variant:"contained",color:m?"error":"primary",autoFocus:!0,children:l})]})]})}function xt(){const r=W();return E({mutationFn:()=>p.getSchedulePreview(),onSuccess:()=>{r.invalidateQueries({queryKey:["schedule","history"]})}})}function mt(){const r=W();return E({mutationFn:t=>p.applySchedule(t),onSuccess:()=>{r.invalidateQueries({queryKey:["schedule","current"]})}})}function gt(){return E({mutationFn:r=>p.getCurrentSchedule(r)})}function yt(r=!0){const t=T({queryKey:["user","flexible-state"],queryFn:()=>p.getFlexibleState(),staleTime:3e4,enabled:r});return{state:t.data,isLoading:t.isLoading,error:t.error,refetch:t.refetch}}function Ce(){const r=W(),t=T({queryKey:["user","settings"],queryFn:()=>p.getUserSettings(),staleTime:60*1e3}),s=E({mutationFn:l=>p.saveUserSettings(l),onSuccess:()=>{r.invalidateQueries({queryKey:["user","settings"]}),r.invalidateQueries({queryKey:["schedule","preview"]})}});return{settings:t.data,isLoading:t.isLoading,error:t.error,updateSettings:s.mutateAsync,isUpdating:s.isPending}}function pt(){var h;const{isAuthorized:r,startAuth:t,refresh:s,isRefreshing:l}=ie(),o=xt(),[d,u]=A.useState({open:!1,message:"",severity:"info"}),[m,j]=A.useState(!1),[f,F]=A.useState({gateway:"",embedded:""}),I=mt(),i=gt(),{settings:y}=Ce(),b=(y==null?void 0:y.SchedulingMode)==="Flexible",{state:c}=yt(b),H=async()=>{try{await o.mutateAsync()}catch(g){console.error("Failed to generate schedule:",g)}},D=async()=>{var g;if(!((g=o.data)!=null&&g.schedulePayload)){u({open:!0,message:"No schedule to apply. Generate a schedule first.",severity:"error"});return}j(!0)},B=async()=>{if(j(!1),!f.gateway||!f.embedded){u({open:!0,message:"Gateway Device ID and Embedded ID are required",severity:"error"});return}try{await I.mutateAsync({gatewayDeviceId:f.gateway,embeddedId:f.embedded,schedulePayload:o.data.schedulePayload}),u({open:!0,message:"Schedule applied successfully!",severity:"success"})}catch(g){u({open:!0,message:`Failed to apply schedule: ${g}`,severity:"error"})}},$=async()=>{try{await i.mutateAsync(f.embedded||void 0),u({open:!0,message:"Current schedule retrieved",severity:"success"})}catch(g){u({open:!0,message:`Failed to retrieve schedule: ${g}`,severity:"error"})}};return e.jsxs(C,{spacing:3,children:[e.jsxs(S,{sx:{p:3},children:[e.jsxs(C,{direction:"row",spacing:2,alignItems:"center",sx:{mb:2},children:[e.jsx(a,{variant:"h5",children:"Daikin Authorization"}),e.jsx(nt,{})]}),e.jsx(C,{direction:{xs:"column",sm:"row"},spacing:2,children:r?e.jsx(w,{variant:"outlined",onClick:()=>s(),disabled:l,children:l?"Refreshing...":"Refresh Token"}):e.jsx(w,{variant:"contained",onClick:t,children:"Start OAuth Flow"})})]}),e.jsx(it,{}),e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,children:"Schedule Preview"}),!r&&e.jsx(k,{severity:"warning",sx:{mb:2},children:"Authorize with Daikin to apply schedules to your device"}),e.jsx(w,{variant:"contained",color:"primary",onClick:H,disabled:o.isPending,sx:{mb:2},children:o.isPending?"Generating...":"Generate Schedule"}),o.isError&&e.jsxs(k,{severity:"error",sx:{mb:2},children:["Failed to generate schedule: ",o.error.message]}),o.data&&e.jsxs(x,{children:[e.jsx(Se,{schedulePayload:o.data.schedulePayload}),e.jsx(ct,{}),o.data.message&&e.jsx(a,{variant:"body2",color:"text.secondary",sx:{mt:2},children:o.data.message})]})]}),b&&c&&e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,children:"Flexible Scheduling Status"}),e.jsxs(C,{spacing:2,children:[e.jsxs(x,{children:[e.jsx(a,{variant:"subtitle1",fontWeight:"bold",children:"Eco (Daily DHW)"}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Last run: ",c.LastEcoRunUtc?new Date(c.LastEcoRunUtc).toLocaleString():"Never (waiting for first interval)"]}),c.EcoWindow.Start&&c.EcoWindow.End&&e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Next window: ",new Date(c.EcoWindow.Start).toLocaleString()," – ",new Date(c.EcoWindow.End).toLocaleString()]})]}),e.jsx(re,{}),e.jsxs(x,{children:[e.jsx(a,{variant:"subtitle1",fontWeight:"bold",children:"Comfort (Legionella)"}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Last run: ",c.LastComfortRunUtc?new Date(c.LastComfortRunUtc).toLocaleString():"Never (waiting for first interval)"]}),c.NextScheduledComfortUtc&&e.jsxs(a,{variant:"body2",color:"primary.main",children:["Next scheduled: ",new Date(c.NextScheduledComfortUtc).toLocaleString()]}),c.ComfortWindow.Start&&c.ComfortWindow.End&&e.jsxs(e.Fragment,{children:[e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Window: ",new Date(c.ComfortWindow.Start).toLocaleString()," – ",new Date(c.ComfortWindow.End).toLocaleString()]}),c.ComfortWindow.Progress!==null&&e.jsxs(x,{sx:{mt:1},children:[e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Window progress: ",(c.ComfortWindow.Progress*100).toFixed(0),"%"]}),e.jsx(x,{sx:{mt:.5,height:8,borderRadius:4,bgcolor:"grey.200",overflow:"hidden"},children:e.jsx(x,{sx:{height:"100%",width:`${(c.ComfortWindow.Progress??0)*100}%`,bgcolor:(c.ComfortWindow.Progress??0)>.9?"warning.main":"primary.main",borderRadius:4,transition:"width 0.3s ease"}})})]})]})]})]})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,children:"Apply Schedule to Daikin"}),e.jsxs(C,{spacing:2,children:[e.jsx(G,{label:"Gateway Device ID",value:f.gateway,onChange:g=>F({...f,gateway:g.target.value}),placeholder:"Enter gateway device ID",fullWidth:!0,disabled:!r}),e.jsx(G,{label:"Embedded ID",value:f.embedded,onChange:g=>F({...f,embedded:g.target.value}),placeholder:"Enter embedded ID",fullWidth:!0,disabled:!r}),e.jsxs(C,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(w,{variant:"contained",onClick:D,disabled:!r||!((h=o.data)!=null&&h.schedulePayload)||I.isPending,children:I.isPending?"Applying...":"Apply Schedule"}),e.jsx(w,{variant:"outlined",onClick:$,disabled:!r||i.isPending,children:i.isPending?"Retrieving...":"Retrieve Current Schedule"})]})]}),!!i.data&&e.jsxs(x,{sx:{mt:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Current Schedule"}),e.jsx(ht,{data:i.data})]})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,children:"Schedule History"}),e.jsx(ut,{})]}),e.jsx(we,{open:m,title:"Apply Schedule",message:"Are you sure you want to apply this schedule to your Daikin device? This will replace the current schedule.",confirmText:"Apply",cancelText:"Cancel",onConfirm:B,onCancel:()=>j(!1)}),e.jsx(ae,{open:d.open,autoHideDuration:6e3,onClose:()=>u({...d,open:!1}),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(k,{onClose:()=>u({...d,open:!1}),severity:d.severity,sx:{width:"100%"},children:d.message})})]})}function ft(){const r=W(),t=T({queryKey:["user","zone"],queryFn:async()=>(await p.getZone()).zone,staleTime:5*60*1e3}),s=E({mutationFn:l=>p.setZone(l),onSuccess:()=>{r.invalidateQueries({queryKey:["user","zone"]}),r.invalidateQueries({queryKey:["prices","timeseries"]}),r.invalidateQueries({queryKey:["schedule","preview"]})}});return{zone:t.data,isLoading:t.isLoading,error:t.error,setZone:s.mutateAsync,isUpdating:s.isPending}}function jt(){return e.jsxs(C,{spacing:3,children:[e.jsxs(S,{sx:{p:3},children:[e.jsx(q,{variant:"text",width:"40%",height:40}),e.jsx(q,{variant:"rectangular",height:200,sx:{mt:2}})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(q,{variant:"text",width:"30%",height:40}),e.jsx(q,{variant:"rectangular",height:150,sx:{mt:2}})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(q,{variant:"text",width:"50%",height:40}),e.jsx(q,{variant:"rectangular",height:100,sx:{mt:2}})]})]})}const vt=["SE1","SE2","SE3","SE4","NO1","NO2","NO3","NO4","NO5","DK1","DK2","FI"];function bt(){const{settings:r,isLoading:t,error:s,updateSettings:l,isUpdating:o}=Ce(),{zone:d,setZone:u,isUpdating:m}=ft(),{isAuthorized:j,refresh:f,revoke:F,isRefreshing:I}=ie(),[i,y]=A.useState({comfortHours:3,turnOffPercentile:.9,maxComfortGapHours:1,autoApplySchedule:!1,selectedZone:"SE3",schedulingMode:"Classic",ecoIntervalHours:24,ecoFlexibilityHours:12,comfortIntervalDays:21,comfortFlexibilityDays:7,comfortEarlyPercentile:.1}),[b,c]=A.useState({open:!1,message:"",severity:"success"}),[H,D]=A.useState(!1);A.useEffect(()=>{r&&y(h=>({...h,comfortHours:r.ComfortHours??3,turnOffPercentile:r.TurnOffPercentile??.9,maxComfortGapHours:r.MaxComfortGapHours??1,autoApplySchedule:r.AutoApplySchedule??!1,schedulingMode:r.SchedulingMode??"Classic",ecoIntervalHours:r.EcoIntervalHours??24,ecoFlexibilityHours:r.EcoFlexibilityHours??12,comfortIntervalDays:r.ComfortIntervalDays??21,comfortFlexibilityDays:r.ComfortFlexibilityDays??7,comfortEarlyPercentile:r.ComfortEarlyPercentile??.1}))},[r]),A.useEffect(()=>{d&&y(h=>({...h,selectedZone:d}))},[d]);const B=async()=>{try{await l({ComfortHours:i.comfortHours,TurnOffPercentile:i.turnOffPercentile,MaxComfortGapHours:i.maxComfortGapHours,AutoApplySchedule:i.autoApplySchedule,SchedulingMode:i.schedulingMode,EcoIntervalHours:i.ecoIntervalHours,EcoFlexibilityHours:i.ecoFlexibilityHours,ComfortIntervalDays:i.comfortIntervalDays,ComfortFlexibilityDays:i.comfortFlexibilityDays,ComfortEarlyPercentile:i.comfortEarlyPercentile}),i.selectedZone!==d&&await u(i.selectedZone),c({open:!0,message:"Settings saved successfully",severity:"success"})}catch(h){c({open:!0,message:`Failed to save settings: ${h}`,severity:"error"})}},$=async()=>{D(!1);try{await F(),c({open:!0,message:"Daikin authentication revoked",severity:"info"})}catch(h){c({open:!0,message:`Failed to revoke: ${h}`,severity:"error"})}};return t?e.jsx(z,{maxWidth:"md",sx:{py:4},children:e.jsx(jt,{})}):s?e.jsx(z,{maxWidth:"md",sx:{py:4},children:e.jsxs(k,{severity:"error",children:["Failed to load settings: ",s.message]})}):e.jsxs(z,{maxWidth:"md",sx:{py:4},children:[e.jsx(a,{variant:"h4",gutterBottom:!0,sx:{fontSize:{xs:"1.5rem",md:"2rem"}},children:"Settings"}),e.jsxs(C,{spacing:3,children:[e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Schedule Configuration"}),e.jsxs(C,{spacing:3,children:[e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Comfort Hours: ",i.comfortHours]}),e.jsx(R,{value:i.comfortHours,onChange:(h,g)=>y({...i,comfortHours:g}),min:1,max:12,step:1,marks:!0,valueLabelDisplay:"auto"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Number of hours per day to heat water to comfort temperature"})]}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Turn Off Percentile: ",(i.turnOffPercentile*100).toFixed(0),"%"]}),e.jsx(R,{value:i.turnOffPercentile,onChange:(h,g)=>y({...i,turnOffPercentile:g}),min:.5,max:.99,step:.01,marks:[{value:.5,label:"50%"},{value:.75,label:"75%"},{value:.99,label:"99%"}],valueLabelDisplay:"auto",valueLabelFormat:h=>`${(h*100).toFixed(0)}%`}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Price threshold for turning off DHW heating (higher = less turn-off)"})]}),e.jsx(G,{label:"Max Comfort Gap (hours)",type:"number",value:i.maxComfortGapHours,onChange:h=>y({...i,maxComfortGapHours:parseInt(h.target.value)||1}),inputProps:{min:1,max:72,step:1},helperText:"Maximum gap between consecutive comfort hours (1-72)"}),e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Nordpool Zone"}),e.jsx(de,{value:i.selectedZone,onChange:h=>y({...i,selectedZone:h.target.value}),label:"Nordpool Zone",children:vt.map(h=>e.jsx(ee,{value:h,children:h},h))})]})]})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Scheduling Mode"}),e.jsxs(C,{spacing:2,children:[e.jsxs(le,{fullWidth:!0,children:[e.jsx(ce,{children:"Mode"}),e.jsxs(de,{value:i.schedulingMode,onChange:h=>y({...i,schedulingMode:h.target.value}),label:"Mode",children:[e.jsx(ee,{value:"Classic",children:"Classic (Fixed daily schedule)"}),e.jsx(ee,{value:"Flexible",children:"Flexible (Interval-based with price optimization)"})]})]}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Classic mode generates a fixed daily schedule. Flexible mode schedules eco and comfort runs at optimal prices within configurable intervals."})]})]}),i.schedulingMode==="Flexible"&&e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Flexible Schedule Settings"}),e.jsxs(C,{spacing:3,children:[e.jsx(a,{variant:"subtitle1",fontWeight:"bold",children:"Eco (Daily DHW ~45°C)"}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Eco Interval: ",i.ecoIntervalHours," hours"]}),e.jsx(R,{value:i.ecoIntervalHours,onChange:(h,g)=>y({...i,ecoIntervalHours:g}),min:6,max:36,step:1,marks:[{value:6,label:"6h"},{value:12,label:"12h"},{value:24,label:"24h"},{value:36,label:"36h"}],valueLabelDisplay:"auto"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"How often eco heating should run (target interval)"})]}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Eco Flexibility: ±",i.ecoFlexibilityHours," hours"]}),e.jsx(R,{value:i.ecoFlexibilityHours,onChange:(h,g)=>y({...i,ecoFlexibilityHours:g}),min:1,max:18,step:1,marks:[{value:1,label:"±1h"},{value:6,label:"±6h"},{value:12,label:"±12h"},{value:18,label:"±18h"}],valueLabelDisplay:"auto"}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Scheduling window: eco runs between ",Math.max(0,i.ecoIntervalHours-i.ecoFlexibilityHours),"h and ",i.ecoIntervalHours+i.ecoFlexibilityHours,"h after last run"]})]}),e.jsx(re,{}),e.jsx(a,{variant:"subtitle1",fontWeight:"bold",children:"Comfort (Legionella ~60°C)"}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Comfort Interval: ",i.comfortIntervalDays," days"]}),e.jsx(R,{value:i.comfortIntervalDays,onChange:(h,g)=>y({...i,comfortIntervalDays:g}),min:7,max:90,step:1,marks:[{value:7,label:"7d"},{value:21,label:"21d"},{value:30,label:"30d"},{value:60,label:"60d"},{value:90,label:"90d"}],valueLabelDisplay:"auto"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"How often comfort (legionella) heating should run"})]}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Comfort Flexibility: ±",i.comfortFlexibilityDays," days"]}),e.jsx(R,{value:i.comfortFlexibilityDays,onChange:(h,g)=>y({...i,comfortFlexibilityDays:g}),min:1,max:30,step:1,marks:[{value:1,label:"±1d"},{value:7,label:"±7d"},{value:14,label:"±14d"},{value:30,label:"±30d"}],valueLabelDisplay:"auto"}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Scheduling window: comfort runs between ",Math.max(0,i.comfortIntervalDays-i.comfortFlexibilityDays),"d and ",i.comfortIntervalDays+i.comfortFlexibilityDays,"d after last run"]})]}),e.jsxs(x,{children:[e.jsxs(a,{gutterBottom:!0,children:["Early Comfort Threshold: ",(i.comfortEarlyPercentile*100).toFixed(0),"th percentile"]}),e.jsx(R,{value:i.comfortEarlyPercentile,onChange:(h,g)=>y({...i,comfortEarlyPercentile:g}),min:.01,max:.5,step:.01,marks:[{value:.05,label:"5%"},{value:.1,label:"10%"},{value:.25,label:"25%"},{value:.5,label:"50%"}],valueLabelDisplay:"auto",valueLabelFormat:h=>`${(h*100).toFixed(0)}%`}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"When the comfort window opens, only trigger if the price is below this historical percentile. The threshold relaxes as the window progresses."})]})]})]}),e.jsxs(S,{sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Automation"}),e.jsx(Ne,{control:e.jsx(se,{checked:i.autoApplySchedule,onChange:h=>y({...i,autoApplySchedule:h.target.checked})}),label:"Auto-apply schedule daily"}),e.jsx(a,{variant:"caption",color:"text.secondary",display:"block",children:"Automatically apply generated schedule to your Daikin device each day"})]}),e.jsx(w,{variant:"contained",size:"large",onClick:B,disabled:o||m,children:o||m?e.jsxs(e.Fragment,{children:[e.jsx(P,{size:20,sx:{mr:1}}),"Saving..."]}):"Save Settings"}),e.jsx(re,{}),e.jsxs(S,{sx:{p:3,border:"1px solid",borderColor:"error.main"},children:[e.jsx(a,{variant:"h6",color:"error",gutterBottom:!0,children:"Danger Zone"}),e.jsxs(C,{spacing:2,children:[e.jsxs(x,{children:[e.jsx(a,{variant:"body2",gutterBottom:!0,children:"Revoke Daikin authentication to disconnect your account."}),e.jsx(w,{variant:"outlined",color:"error",onClick:()=>D(!0),disabled:!j,children:"Revoke Daikin Access"})]}),e.jsxs(x,{children:[e.jsx(a,{variant:"body2",gutterBottom:!0,children:"Refresh authentication token (use if experiencing connectivity issues)."}),e.jsx(w,{variant:"outlined",onClick:()=>f(),disabled:!j||I,children:I?"Refreshing...":"Refresh Token"})]})]})]})]}),e.jsx(we,{open:H,title:"Revoke Daikin Access",message:"Are you sure you want to revoke access to your Daikin account? You will need to re-authorize to use schedule application features.",confirmText:"Revoke",cancelText:"Cancel",onConfirm:$,onCancel:()=>D(!1),isDestructive:!0}),e.jsx(ae,{open:b.open,autoHideDuration:6e3,onClose:()=>c({...b,open:!1}),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(k,{onClose:()=>c({...b,open:!1}),severity:b.severity,children:b.message})})]})}function St(){var h,g,oe;const r=W(),[t,s]=A.useState(""),[l,o]=A.useState(null),[d,u]=A.useState({open:!1,message:"",severity:"error"}),[m,j]=A.useState(new Set),[f,F]=A.useState(null),I=T({queryKey:["admin-status"],queryFn:()=>p.getAdminStatus()}),i=((h=I.data)==null?void 0:h.isAdmin)??!1,y=T({queryKey:["admin-users"],queryFn:()=>p.getAdminUsers(),enabled:i}),b=E({mutationFn:n=>p.adminLogin(n),onSuccess:()=>{o(null),s(""),r.invalidateQueries({queryKey:["admin-status"]})},onError:n=>{o(n.message||"Login failed")}}),c=E({mutationFn:n=>n.isAdmin?p.revokeAdmin(n.userId):p.grantAdmin(n.userId),onMutate:n=>{j(M=>new Set(M).add(`admin-${n.userId}`))},onSettled:(n,M,U)=>{U&&j(_=>{const O=new Set(_);return O.delete(`admin-${U.userId}`),O}),r.invalidateQueries({queryKey:["admin-users"]})},onError:n=>{u({open:!0,message:`Admin toggle failed: ${n.message}`,severity:"error"})}}),H=E({mutationFn:n=>n.hasHangfireAccess?p.revokeHangfire(n.userId):p.grantHangfire(n.userId),onMutate:n=>{j(M=>new Set(M).add(`hangfire-${n.userId}`))},onSettled:(n,M,U)=>{U&&j(_=>{const O=new Set(_);return O.delete(`hangfire-${U.userId}`),O}),r.invalidateQueries({queryKey:["admin-users"]})},onError:n=>{u({open:!0,message:`Hangfire toggle failed: ${n.message}`,severity:"error"})}}),D=E({mutationFn:n=>p.deleteUser(n),onSuccess:()=>{F(null),u({open:!0,message:"Användare borttagen",severity:"success"}),r.invalidateQueries({queryKey:["admin-users"]})},onError:n=>{u({open:!0,message:`Kunde inte ta bort: ${n.message}`,severity:"error"})}}),B=n=>{n.preventDefault(),t.trim()&&b.mutate(t)};if(I.isLoading)return e.jsx(z,{maxWidth:"lg",sx:{py:4,display:"flex",justifyContent:"center"},children:e.jsx(P,{})});if(!i)return e.jsx(z,{maxWidth:"sm",sx:{py:4},children:e.jsxs(S,{sx:{p:4},children:[e.jsx(a,{variant:"h4",gutterBottom:!0,children:"Admin"}),e.jsx("form",{onSubmit:B,children:e.jsxs(C,{spacing:2,children:[e.jsx(G,{label:"Lösenord",type:"password",fullWidth:!0,value:t,onChange:n=>s(n.target.value),autoFocus:!0}),l&&e.jsx(k,{severity:"error",children:l}),e.jsx(w,{type:"submit",variant:"contained",disabled:b.isPending||!t.trim(),startIcon:b.isPending?e.jsx(P,{size:18}):void 0,children:"Logga in"})]})})]})});const $=((g=y.data)==null?void 0:g.users)??[];return e.jsxs(z,{maxWidth:"lg",sx:{py:4},children:[e.jsx(a,{variant:"h4",gutterBottom:!0,sx:{fontSize:{xs:"1.5rem",md:"2rem"}},children:"Användare"}),y.isLoading&&e.jsx(x,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(P,{})}),y.error&&e.jsxs(k,{severity:"error",sx:{mb:2},children:["Kunde inte hämta användare: ",y.error.message]}),y.data&&e.jsx(Ke,{component:S,children:e.jsxs(Qe,{size:"small",children:[e.jsx(Ge,{children:e.jsxs(te,{children:[e.jsx(v,{children:"Användare"}),e.jsx(v,{children:"Zon"}),e.jsx(v,{children:"Inställningar"}),e.jsx(v,{children:"Daikin"}),e.jsx(v,{children:"Daikin Subject"}),e.jsx(v,{children:"Schema"}),e.jsx(v,{children:"Admin"}),e.jsx(v,{children:"Hangfire"}),e.jsx(v,{children:"Skapad"}),e.jsx(v,{children:"Åtgärd"})]})}),e.jsxs(Ze,{children:[$.map(n=>e.jsxs(te,{sx:n.isCurrentUser?{bgcolor:"action.selected"}:void 0,children:[e.jsx(v,{children:e.jsxs(C,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(L,{title:n.userId,children:e.jsx(a,{variant:"body2",sx:{fontFamily:"monospace",cursor:"pointer",userSelect:"all"},children:n.userId})}),n.isCurrentUser&&e.jsx(Q,{label:"Du",color:"primary",size:"small"})]})}),e.jsx(v,{children:n.zone||"—"}),e.jsx(v,{children:e.jsxs(a,{variant:"body2",noWrap:!0,children:[n.settings.ComfortHours,"h, ",(n.settings.TurnOffPercentile*100).toFixed(0),"%"]})}),e.jsx(v,{children:n.daikinAuthorized?e.jsx(L,{title:n.daikinExpiresAtUtc?`Utgår: ${n.daikinExpiresAtUtc}`:"Auktoriserad",children:e.jsx(ge,{color:"success",fontSize:"small"})}):e.jsx(L,{title:"Ej auktoriserad",children:e.jsx(_e,{color:"error",fontSize:"small"})})}),e.jsx(v,{children:n.daikinSubject?e.jsx(L,{title:n.daikinSubject,children:e.jsx(a,{variant:"body2",sx:{fontFamily:"monospace",cursor:"pointer",userSelect:"all",maxWidth:120,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:n.daikinSubject})}):e.jsx(a,{variant:"body2",color:"text.secondary",children:"—"})}),e.jsx(v,{children:n.hasScheduleHistory?e.jsx(L,{title:n.lastScheduleDate?`Senast: ${n.lastScheduleDate}`:"",children:e.jsxs(a,{variant:"body2",children:[n.scheduleCount," st"]})}):"—"}),e.jsx(v,{children:m.has(`admin-${n.userId}`)?e.jsx(P,{size:20}):e.jsx(se,{checked:n.isAdmin,disabled:n.isCurrentUser,onChange:()=>c.mutate(n),size:"small"})}),e.jsx(v,{children:m.has(`hangfire-${n.userId}`)?e.jsx(P,{size:20}):e.jsx(se,{checked:n.hasHangfireAccess,onChange:()=>H.mutate(n),size:"small"})}),e.jsx(v,{children:n.createdAt?e.jsx(L,{title:`${new Date(n.createdAt).toISOString()}`,children:e.jsx(a,{variant:"body2",children:new Date(n.createdAt).toLocaleString(void 0,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})}):e.jsx(a,{variant:"body2",children:"—"})}),e.jsx(v,{children:e.jsx(L,{title:n.isCurrentUser?"Kan inte ta bort dig själv":"Ta bort användare",children:e.jsx("span",{children:e.jsx(Je,{size:"small",color:"error",disabled:n.isCurrentUser,onClick:()=>F(n),"aria-label":n.isCurrentUser?"Kan inte ta bort din egen användare":`Ta bort användare ${n.userId.slice(0,8)}`,children:e.jsx(ue,{fontSize:"small"})})})})})]},n.userId)),$.length===0&&e.jsx(te,{children:e.jsx(v,{colSpan:10,align:"center",children:e.jsx(a,{variant:"body2",color:"text.secondary",children:"Inga användare"})})})]})]})}),e.jsxs(ye,{open:f!==null,onClose:()=>F(null),children:[e.jsx(pe,{children:"Ta bort användare"}),e.jsx(fe,{children:e.jsxs(je,{children:["Är du säker på att du vill ta bort användare"," ",e.jsxs("strong",{children:[(oe=f==null?void 0:f.userId)==null?void 0:oe.slice(0,8),"…"]}),"?"," ","All data (inställningar, tokens, schemahistorik) kommer att raderas permanent."]})}),e.jsxs(ve,{children:[e.jsx(w,{onClick:()=>F(null),children:"Avbryt"}),e.jsx(w,{onClick:()=>f&&D.mutate(f.userId),color:"error",variant:"contained",disabled:D.isPending,startIcon:D.isPending?e.jsx(P,{size:18}):e.jsx(ue,{}),children:"Ta bort"})]})]}),e.jsx(ae,{open:d.open,autoHideDuration:4e3,onClose:()=>u(n=>({...n,open:!1})),children:e.jsx(k,{severity:d.severity,onClose:()=>u(n=>({...n,open:!1})),children:d.message})})]})}class wt extends A.Component{constructor(s){super(s);J(this,"handleReset",()=>{this.setState({hasError:!1,error:void 0}),window.location.href="/"});this.state={hasError:!1}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,l){console.error("ErrorBoundary caught error:",s,l)}render(){var s;return this.state.hasError?e.jsx(z,{maxWidth:"sm",sx:{py:8},children:e.jsx(S,{sx:{p:4,textAlign:"center"},children:e.jsxs(C,{spacing:3,alignItems:"center",children:[e.jsx(Xe,{color:"error",sx:{fontSize:64}}),e.jsx(a,{variant:"h4",children:"Something went wrong"}),e.jsx(a,{variant:"body1",color:"text.secondary",children:((s=this.state.error)==null?void 0:s.message)||"An unexpected error occurred"}),e.jsx(w,{variant:"contained",onClick:this.handleReset,children:"Return to Dashboard"})]})})}):this.props.children}}const Ct=new ke({defaultOptions:{queries:{refetchOnWindowFocus:!1,retry:1}}});function Dt(){return e.jsx(wt,{children:e.jsx(Fe,{client:Ct,children:e.jsxs(Ve,{theme:tt,children:[e.jsx(Ye,{}),e.jsx(Ee,{children:e.jsx(st,{children:e.jsxs(Pe,{children:[e.jsx(V,{path:"/",element:e.jsx(pt,{})}),e.jsx(V,{path:"/settings",element:e.jsx(bt,{})}),e.jsx(V,{path:"/admin",element:e.jsx(St,{})})]})})},"router")]})})})}ne.createRoot(document.getElementById("root")).render(e.jsx(He.StrictMode,{children:e.jsx(Dt,{})}));
//# sourceMappingURL=index-BfpFhcLX.js.map

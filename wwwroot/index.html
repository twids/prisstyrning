<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Prisstyrning</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="/ui.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js time scale kräver en date adapter; lägg till date-fns adapter -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head><body>
<header style="display:flex;justify-content:space-between;align-items:center;">
	<h1 style="margin:0;font-size:1.4rem;">Prisstyrning</h1>
	<nav style="display:flex;align-items:center;gap:1rem;">
		<a href="/settings.html" title="Schedule settings" style="color:#fff;text-decoration:none;font-size:1.3rem;line-height:1;display:inline-flex;align-items:center;gap:.35rem;">
			<span style="font-size:1.2rem;">⚙</span><span style="font-size:.8rem;letter-spacing:.5px;">Settings</span>
		</a>
	</nav>
</header>
<main>
<!-- Combined Status + Daikin section -->
<section id="daikinStatus">
	<h2>Daikin</h2>
	<div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.4rem;">
		<div id="authStatus">Loading...</div>
		<button id="authStart">Start OAuth</button>
		<button id="showSites">Sites</button>
		<button id="showGateway">Gateway</button>
		<button id="refreshStatus" style="display:none;">Refresh status</button>
	</div>
	<pre id="daikinData" style="max-height:220px;overflow:auto;"></pre>
	<pre id="gatewayData" style="max-height:260px;overflow:auto;margin-top:.5rem;"></pre>
</section>

<section id="priceBlock">
  <h2>Prices & Nordpool Zone</h2>
  <div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;">
    <label>Zone:
      <select id="zoneSelect" style="min-width:90px;">
        <option value="SE1">SE1</option>
        <option value="SE2">SE2</option>
        <option value="SE3">SE3</option>
        <option value="SE4">SE4</option>
        <option value="NO1">NO1</option>
        <option value="NO2">NO2</option>
        <option value="NO3">NO3</option>
        <option value="NO4">NO4</option>
        <option value="NO5">NO5</option>
        <option value="DK1">DK1</option>
        <option value="DK2">DK2</option>
        <option value="FI">FI</option>
        <option value="EE">EE</option>
        <option value="LV">LV</option>
        <option value="LT">LT</option>
      </select>
    </label>
	<button id="saveZone">Save zone</button>
    <span id="latestPriceMeta" style="font-size:.7rem;opacity:.7"></span>
    <span id="zoneLabel" class="zone-label"></span>
  </div>
  <div style="margin-top:1rem;">
    <div style="display:flex;align-items:center;gap:.8rem;">
      <canvas id="chart" height="120" style="max-width:100%;"></canvas>
    </div>
    <div id="chartMeta" style="font-size:.8rem;opacity:.7;margin-top:.3rem;"></div>
  </div>
</section>
<section id="schedule"><h2>DHW Schedule – Preview & Current</h2>
	<div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.4rem;">
		<button id="loadSchedule">Generate</button>
		<button id="loadCurrentSchedule" title="Fetch current DHW (embeddedId 2) schedule from Daikin">Current DHW schedule</button>
		<span id="scheduleMsg" style="font-size:.8rem;opacity:.8"></span>
		<span style="display:inline-flex;align-items:center;gap:.25rem;font-size:.7rem;">Legend:
			<span class="sch-box comfort"></span> comfort
			<span class="sch-box eco"></span> eco
			<span class="sch-box off"></span> off
		</span>
	</div>
	<div style="display:grid;gap:1.2rem;">
		<div>
			<div style="font-size:.75rem;opacity:.8;margin-bottom:.2rem;">Generated DHW (preview)</div>
			<div id="scheduleGrid" class="schedule-grid"></div>
			<div style="margin-top:.5rem;display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;font-size:.7rem;border:1px solid #333;padding:.4rem;border-radius:4px;">
				<label>DHW GatewayDeviceId <input id="putGatewayDeviceId" placeholder="gatewayDeviceId" style="width:160px;font-size:.7rem;"/></label>
				<label>DHW EmbeddedId <input id="putEmbeddedId" placeholder="2" style="width:120px;font-size:.7rem;"/></label>
				<label>Mode <input id="putMode" value="heating" style="width:80px;font-size:.7rem;"/></label>
				<label>Activate ScheduleId <input id="putActivateId" placeholder="(optional)" style="width:120px;font-size:.7rem;"/></label>
				<button id="applyScheduleBtn" title="Upload schedulePayload from preview">PUT schedule</button>
				<span id="applyResult" style="opacity:.8;"></span>
			</div>
		</div>
		<div>
			<div style="font-size:.75rem;opacity:.8;margin:.6rem 0 .2rem;display:flex;align-items:center;gap:.6rem;">Current DHW (live)
		  <button id="toggleCurrentRaw" style="font-size:.6rem;">Show raw JSON</button>
        </div>
			<div id="currentScheduleGrid" class="schedule-grid"></div>
			<pre id="currentScheduleRaw" style="margin-top:.3rem;max-height:220px;overflow:auto;display:none;"></pre>
		</div>
	</div>
	<pre id="schedulePreview" style="margin-top:.5rem;"></pre>
</section>
<style>
	.schedule-grid{display:grid;gap:2px;margin-top:.4rem;max-width:100%;overflow:auto;font-family:system-ui,Segoe UI,Arial,sans-serif;}
	.schedule-grid .day-row{display:grid;grid-template-columns:70px repeat(24,1fr);gap:2px;}
	.schedule-grid .hdr{font-size:.65rem;text-align:center;opacity:.7;}
	.schedule-grid .day-label{font-size:.65rem;text-align:right;padding:2px 4px;white-space:nowrap;}
	.schedule-grid .cell{height:20px;position:relative;border:1px solid #222;border-radius:2px;overflow:hidden;}
	.schedule-grid .cell span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:600;color:#111;text-shadow:0 0 2px rgba(255,255,255,.6);} 
	.sch-box{width:14px;height:14px;border:1px solid #222;border-radius:3px;display:inline-block;}
	.comfort{background:linear-gradient(#8BC34A,#66BB6A);} 
	.eco{background:linear-gradient(#90A4AE,#607D8B);} 
	.off{background:linear-gradient(#EF5350,#D32F2F);} 
	.schedule-grid .cell.comfort span{color:#0d2;}
	.schedule-grid .cell.eco span{color:#eee;}
	.schedule-grid .cell.off span{color:#fff;}
	.schedule-grid .now{outline:2px solid #fff;box-shadow:0 0 4px 2px #fff inset;}
</style>
<!-- Removed separate Daikin section (merged above) -->
</main>
<script type="module" src="/ui.js"></script>
<script>
const rawContainer = document.createElement('div');
rawContainer.id='rawPriceList';
rawContainer.style.cssText='margin-top:1rem;font-family:monospace;font-size:.7rem;white-space:pre;max-height:200px;overflow:auto;border:1px solid #333;padding:.5rem;display:none;';
document.getElementById('priceChart').appendChild(rawContainer);
const toggleBtn = document.createElement('button');
toggleBtn.textContent='Visa rådata';
toggleBtn.style.marginTop='.5rem';
toggleBtn.onclick=()=>{rawContainer.style.display= rawContainer.style.display==='none'?'block':'none'; toggleBtn.textContent = rawContainer.style.display==='none'?'Visa rådata':'Dölj rådata';};
document.getElementById('priceChart').appendChild(toggleBtn);

async function loadChart(){
	const url = '/api/prices/timeseries?source=latest';
	const res = await fetch(url);
	if(!res.ok){ document.getElementById('chartMeta').textContent='Ingen data'; return; }
	const data = await res.json();
	const items = (data.items||[]).slice().sort((a,b)=> new Date(a.start)-new Date(b.start));
	console.debug('[PriceChart] Items', items.length, items.slice(0,5));
	const today = [], tomorrow = [];
	for(const it of items){
		const ts = new Date(it.start);
		if(it.day==='tomorrow') tomorrow.push({ x: ts, y: it.value }); else today.push({ x: ts, y: it.value });
	}
	const all = [...today, ...tomorrow];
	const minX = all.length? all[0].x : undefined;
	const maxX = all.length? all[all.length-1].x : undefined;
	const ctx = document.getElementById('chart').getContext('2d');
	if(window._priceChart){ window._priceChart.destroy(); }
	window._priceChart = new Chart(ctx, {
		type:'line',
		data:{ datasets:[
			today.length?{label:'Idag', data:today, borderColor:'#4FC3F7', backgroundColor:'#4FC3F755', fill:true, tension:.15, pointRadius:3 }:null,
			tomorrow.length?{label:'Imorgon', data:tomorrow, borderColor:'#FFB74D', backgroundColor:'#FFB74D55', fill:true, tension:.15, pointRadius:3 }:null
		].filter(Boolean)},
		options:{
			parsing:false,
			spanGaps:true,
			scales:{
				x:{ type:'time', time:{ unit:'hour', tooltipFormat:'yyyy-MM-dd HH:mm' }, ticks:{ source:'data', autoSkip:false, maxRotation:45, minRotation:0 }, min:minX, max:maxX },
				y:{ title:{display:true,text:'Öre/kWh'}, beginAtZero:true }
			},
			plugins:{ legend:{position:'bottom'} }
		}
	});
	rawContainer.textContent = items.map(i=>`${i.day.padEnd(8)} ${i.start}  ${i.value}`).join('\n');
	document.getElementById('chartMeta').textContent = `Antal punkter: ${items.length} | Källa: ${data.source} ${data.updated? '| Uppdaterad: '+data.updated:''}`;
}
loadChart();
setInterval(loadChart, 5*60*1000);
</script>
</body></html>
